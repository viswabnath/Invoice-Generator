<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <script src="script.js"></script>
</head>

<body>
    <div id="invoice-wrapper" style="padding: 10px;">
        <div class="container" id="invoice">
            <button class="top-right-button" onclick="taxInvoice()">For Tax Invoice</button>

            <div class="header">
                <img src="./Logo.png" alt="Logo">
                <h5> INVOICE</h5>
            </div>

            <!-- Client and Invoice Details -->
            <div class="details">
                <div class="field-row">
                    <div class="field">
                        <strong>Client:</strong>
                        <span id="client-name" contenteditable="true" placeholder="Client Name"></span>
                    </div>
                    <div class="field">
                        <strong>Address:</strong>
                        <span contenteditable="true" class="client-address" placeholder="Client Address"></span>
                    </div>
                </div>
                <div class="field-row">
                    <div class="field">
                        <strong>Invoice No:</strong>
                        <span contenteditable="true" placeholder="Invoice Number"></span>
                    </div>
                    <div class="field">
                        <strong>Invoice Date:</strong>
                        <input type="date" value="2024-12-02" placeholder="Invoice Date">
                    </div>
                </div>
            </div>

            <!-- Add and Remove Row Buttons -->
            <div class="btn-container">
                <button id="addRow" class="btn btn-success hide-in-pdf">Add Row</button>
                <button id="removeRow" class="btn btn-danger hide-in-pdf">Remove Row</button>
                <button id="exportBtn" class="btn btn-primary hide-in-pdf">Export to PDF</button>
            </div>

            <!-- Invoice Table -->
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>HSN Code</th>
                        <th>Qty</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    <!-- Initially no rows, dynamic rows will be added -->
                </tbody>
            </table>

            <!-- Totals -->
            <div class="totals">
                <p><strong>Grand Total:</strong> <span id="grand-total">00.00</span></p>
            </div>

            <div class="line"></div>
            <!-- Footer -->
            <div class="row">
                <div class="col-md-6">
                    <div class="bank-details">
                        <p><strong>Bank Account Details:</strong></p>
                        <p><strong>Bank Name:</strong> INDUSIND BANK</p>
                        <p><strong>Account Holder Name:</strong> OneMark</p>
                        <p><strong>Account Number:</strong> 259818619622</p>
                        <p><strong>IFSC Code:</strong> INDB0001479</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="signature-boxes">
                        <div class="signature-box">
                            <p>Receiver's Signature</p>
                        </div>
                        <div class="signature-box">
                            <p>Authorized Signature</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="line"></div>


            <!-- OneMark Address Section -->
            <div class="company-details text-center">
                <p><strong>ONEMARK, Regd Office:</strong> FF2 Manasa Park View Apartments, Gandhi Nagar, Kakinada,
                    Andhra Pradesh, India - 533003.</p>
                <p><strong>GSTIN:</strong> 37CPQPP3879D1Z7</p>
                <p>Contact No: +91 9618619622, 7013313686 | Email: support@onemark.co.in | Website: www.onemark.co.in
                </p>
            </div>
            <div class="line"></div>
            <p class="note">*For questions about this invoice, please contact: support@onemark.co.in</p>
            <p class="warn">Our Bank details have not changed. If you do have instruction to change the bank details you
                have on file or the payment of our invoices, Please contact us directly by
                the phone number you already have on your records for confirmation. This is to help combat an
                increasingly common scam whereby false bank details change requests
                are sent by unrelated third parties, potentially resulting in significant loss.</p>
            <div class="line"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
    <script>
        function taxInvoice() {
            window.location.href = './tax-invoice.html'
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            validateFieldsAndTable();
        });

        // Update calculations
        function updateCalculations() {
            const rows = document.querySelectorAll('tbody tr');
            let totalExclTax = 0;

            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.qty').textContent) || 0;
                const unitPrice = parseFloat(row.querySelector('.unit-price').textContent) || 0;

                const exclTax = qty * unitPrice;

                row.querySelector('.line-total').textContent = exclTax.toFixed(2);
                totalExclTax += exclTax;
            });

            // Update the total excluding tax and grand total
            document.getElementById('grand-total').textContent = totalExclTax.toFixed(2);
        }

        // Add row functionality
        document.getElementById('addRow').addEventListener('click', () => {
            const tableBody = document.querySelector('table tbody');
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
        <td contenteditable="true" class="description">Description</td>
        <td contenteditable="true" class="hsn-code">998361</td>
        <td contenteditable="true" class="qty">01</td>
        <td contenteditable="true" class="unit-price">0</td>
        <td class="line-total">0.00</td>
    `;
            tableBody.appendChild(newRow);

            updateCalculations();  // Immediately update calculations after adding row
            validateFieldsAndTable();  // Validate fields and enable/disable the export button
        });
        // Remove row functionality
        document.getElementById('removeRow').addEventListener('click', () => {
            const tableBody = document.querySelector('table tbody');
            if (tableBody.lastElementChild) {
                tableBody.lastElementChild.remove();
            }
            updateCalculations();  // Immediately update calculations after removing row
            validateFieldsAndTable();  // Validate fields and enable/disable the export button
        });

        // Real-time update for each field in the table
        document.addEventListener('input', (event) => {
            if (event.target.classList.contains('qty') || event.target.classList.contains('unit-price')) {
                updateCalculations();  // Update calculations on any input change
                validateFieldsAndTable();  // Revalidate after changes
            }
        });

        // Function to calculate and update totals
        function updateCalculations() {
            const rows = document.querySelectorAll('tbody tr');
            let totalExclTax = 0;

            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.qty').textContent) || 0;
                const unitPrice = parseFloat(row.querySelector('.unit-price').textContent) || 0;

                const exclTax = qty * unitPrice;

                row.querySelector('.line-total').textContent = exclTax.toFixed(2);
                totalExclTax += exclTax;
            });

            // Update the grand total
            document.getElementById('grand-total').textContent = totalExclTax.toFixed(2);
        }

        // Main validation function
        function validateFieldsAndTable() {
            const clientName = document.querySelector('[contenteditable="true"][placeholder="Client Name"]').textContent.trim();
            const address = document.querySelector('.client-address').textContent.trim();
            const invoiceNumber = document.querySelector('[contenteditable="true"][placeholder="Invoice Number"]').textContent.trim();
            const invoiceDate = document.querySelector('[type="date"]').value.trim();
            const tableRows = document.querySelectorAll('table tbody tr');

            const exportBtn = document.getElementById('exportBtn');

            // Validate fields above the table
            const isClientNameValid = clientName.length > 0;
            const isAddressValid = address.length > 0;
            const isInvoiceNumberValid = /^[a-zA-Z0-9\-\/]+$/.test(invoiceNumber) && invoiceNumber.length > 0;
            const isDateValid = Boolean(Date.parse(invoiceDate)); // Checks if date is valid

            // Check if there are rows and if they are valid
            let isTableValid = true;
            if (tableRows.length === 0) {
                isTableValid = false; // No rows means the table is invalid
            } else {
                tableRows.forEach(row => {
                    const description = row.querySelector('.description').textContent.trim();
                    const qty = parseFloat(row.querySelector('.qty').textContent) || 0;
                    const unitPrice = parseFloat(row.querySelector('.unit-price').textContent) || 0;

                    // If any row has invalid values, set tableValid to false
                    if (!description || qty <= 0 || unitPrice <= 0) {
                        isTableValid = false;
                    }
                });
            }

            // Enable/disable Export button: Fields must be valid and all rows must be valid
            const isValid = isClientNameValid && isAddressValid && isInvoiceNumberValid && isDateValid && isTableValid;
            exportBtn.disabled = !isValid;
        }

        // Export to PDF
        document.getElementById('exportBtn').addEventListener('click', () => {
            // Hide unwanted elements
            document.querySelectorAll('.hide-in-pdf').forEach(button => {
                button.style.display = 'none';
            });

            const fileName = prompt("Enter a name for the PDF file:", "Invoice");

            if (fileName) {
                const invoiceWrapper = document.getElementById('invoice-wrapper');
                invoiceWrapper.classList.add('pdf-export');

                html2pdf()
                    .set({
                        margin: 10,
                        filename: `${fileName}.pdf`,
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                    })
                    .from(invoiceWrapper)
                    .toPdf()
                    .get('pdf')
                    .then(pdf => {
                        const pageCount = pdf.internal.getNumberOfPages();
                        for (let i = 1; i <= pageCount; i++) {
                            pdf.setPage(i);
                            pdf.setDrawColor(0, 0, 0); // Black border
                            pdf.rect(10, 10, pdf.internal.pageSize.width - 20, pdf.internal.pageSize.height - 20);
                        }
                    })
                    .save()
                    .finally(() => {
                        invoiceWrapper.classList.remove('pdf-export');
                    });
            }

            // Restore hidden elements
            setTimeout(() => {
                document.querySelectorAll('.hide-in-pdf').forEach(button => {
                    button.style.display = 'inline-block';
                });
            }, 1000);
        });

        // Real-time validation for fields
        document.querySelector('[contenteditable="true"][placeholder="Client Name"]').addEventListener('input', validateFieldsAndTable);
        document.querySelector('.client-address').addEventListener('input', validateFieldsAndTable);
        document.querySelector('[contenteditable="true"][placeholder="Invoice Number"]').addEventListener('input', validateFieldsAndTable);
        document.querySelector('[type="date"]').addEventListener('change', validateFieldsAndTable);

        // Ensure row updates trigger recalculations
        document.querySelectorAll('.qty, .unit-price').forEach(input => {
            input.addEventListener('input', () => {
                updateCalculations();
                validateFieldsAndTable(); // Revalidate after changes
            });
        });
        document.addEventListener('input', (event) => {
            const target = event.target;

            if (target.tagName === 'INPUT' || target.getAttribute('contenteditable') === 'true') {
                // For input fields
                if (target.tagName === 'INPUT') {
                    const cursorPosition = target.selectionStart; // Save cursor position
                    target.value = target.value.toUpperCase(); // Transform to uppercase
                    target.setSelectionRange(cursorPosition, cursorPosition); // Restore cursor position
                }

                // For contenteditable elements
                if (target.getAttribute('contenteditable') === 'true') {
                    const selection = window.getSelection();
                    const range = selection.getRangeAt(0);
                    const cursorOffset = range.startOffset; // Save cursor position in contenteditable element

                    target.textContent = target.textContent.toUpperCase(); // Transform to uppercase

                    // Restore cursor position
                    const newRange = document.createRange();
                    newRange.setStart(target.firstChild, Math.min(cursorOffset, target.textContent.length));
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
            }
        });
    </script>


</body>

</html>